# 實作計畫：本地音樂播放器

## 概述

本實作計畫將 Vue 3 本地音樂播放器的設計轉換為可執行的開發任務。實作將採用增量方式，從核心基礎設施開始，逐步加入功能，並在每個階段進行測試驗證。技術棧使用 Vue 3 Composition API、PrimeVue、Vite 和 JavaScript。

## 任務

- [x] 1. 專案初始化和基礎設定
  - 使用 Vite 建立 Vue 3 專案
  - 安裝依賴：PrimeVue、Pinia、vue-i18n、jsmediatags、fast-check、vitest
  - 設定 Vitest 測試環境
  - 建立基本的目錄結構
  - 設定 PrimeVue 主題系統
  - _需求：13.1, 13.2, 13.3_

- [ ] 2. 實作本地儲存服務
  - [x] 2.1 建立 storageService.js
    - 實作 saveToStorage(key, data) 函數
    - 實作 loadFromStorage(key) 函數
    - 實作錯誤處理（QuotaExceededError、資料損壞）
    - _需求：15.1, 15.2, 15.3, 15.4, 15.6_
  
  - [ ]* 2.2 撰寫本地儲存服務的屬性測試
    - **屬性 3：音樂庫持久化往返**
    - **驗證需求：1.3, 1.5**
  
  - [ ]* 2.3 撰寫本地儲存服務的單元測試
    - 測試儲存空資料
    - 測試載入不存在的資料
    - 測試 localStorage 已滿的錯誤處理
    - _需求：15.6_

- [ ] 3. 實作音樂檔案處理和元資料解析
  - [x] 3.1 建立 metadataService.js
    - 使用 jsmediatags 解析 ID3 標籤
    - 提取標題、藝術家、專輯、時長
    - 提取專輯封面圖片
    - 處理解析失敗的情況
    - _需求：1.2, 7.1_
  
  - [x] 3.2 建立 fileUtils.js
    - 實作檔案格式驗證
    - 實作檔案讀取功能
    - 處理不支援的格式
    - _需求：1.1, 1.4_
  
  - [ ]* 3.3 撰寫元資料解析的屬性測試
    - **屬性 1：音樂檔案載入完整性**
    - **驗證需求：1.1, 1.2**
  
  - [ ]* 3.4 撰寫檔案格式驗證的屬性測試
    - **屬性 2：不支援格式拒絕**
    - **驗證需求：1.4**

- [ ] 4. 實作 Pinia stores
  - [x] 4.1 建立 musicLibrary store
    - 定義 state（music、artists、albums、likedMusic）
    - 實作 addMusic action
    - 實作 removeMusic action
    - 實作 toggleLike action
    - 實作 categorizeMusic action
    - 實作 loadFromStorage 和 saveToStorage
    - _需求：1.1, 1.3, 1.5, 4.1, 4.2, 9.1, 9.2_
  
  - [x] 4.2 建立 player store
    - 定義 state（currentMusicId、isPlaying、currentTime、volume、playMode、queue）
    - 實作播放控制 actions（play、pause、togglePlayPause）
    - 實作導航 actions（next、previous）
    - 實作 seek 和 setVolume
    - 實作 setPlayMode 和 shuffleQueue
    - _需求：2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 2.9_
  
  - [x] 4.3 建立 playlist store
    - 定義 state（playlists）
    - 實作 createPlaylist action
    - 實作 addMusicToPlaylist 和 removeMusicFromPlaylist
    - 實作 deletePlaylist action
    - 實作 reorderPlaylist action
    - 實作 exportPlaylist 和 importPlaylist
    - _需求：3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8_
  
  - [x] 4.4 建立 preferences store
    - 定義 state（theme、language、adaptiveColor、categorizeView）
    - 實作 setTheme、setLanguage actions
    - 實作 toggleAdaptiveColor、toggleCategorizeView
    - 實作持久化
    - _需求：10.1, 10.3, 12.1, 12.3, 8.5, 9.6_

- [x] 5. 檢查點 - 確保所有測試通過
  - 確保所有測試通過，如有問題請詢問使用者。

- [ ] 6. 實作音訊播放服務
  - [x] 6.1 建立 audioService.js
    - 使用 HTML5 Audio API
    - 實作播放、暫停、停止功能
    - 實作進度追蹤和更新
    - 實作音量控制
    - 處理播放完畢事件
    - 處理播放錯誤
    - _需求：2.1, 2.2, 2.5, 2.6, 2.11_
  
  - [ ]* 6.2 撰寫播放器控制的屬性測試
    - **屬性 4：播放狀態切換**
    - **驗證需求：2.1, 2.2, 14.1**
  
  - [ ]* 6.3 撰寫播放器導航的屬性測試
    - **屬性 5：播放清單導航**
    - **驗證需求：2.3, 2.4, 14.2, 14.3**
  
  - [ ]* 6.4 撰寫播放位置和音量的屬性測試
    - **屬性 6：播放位置控制**
    - **屬性 7：音量控制範圍**
    - **驗證需求：2.5, 2.6, 14.4, 14.5**

- [ ] 7. 實作播放模式邏輯
  - [x] 7.1 在 player store 中實作播放模式
    - 實作順序播放邏輯
    - 實作單曲循環邏輯
    - 實作播放清單循環邏輯
    - 實作隨機播放邏輯（Fisher-Yates 洗牌演算法）
    - _需求：2.7, 2.8, 2.9, 2.10_
  
  - [ ]* 7.2 撰寫播放模式的屬性測試
    - **屬性 8：單曲循環行為**
    - **屬性 9：播放清單循環行為**
    - **屬性 10：隨機播放包含性**
    - **驗證需求：2.7, 2.8, 2.9**

- [ ] 8. 實作主題系統
  - [x] 8.1 建立 themeService.js 和 CSS 變數
    - 定義暗色主題 CSS 變數
    - 定義亮色主題 CSS 變數
    - 實作主題切換邏輯
    - 實作磨砂玻璃效果樣式
    - _需求：10.1, 10.2, 11.1, 11.2, 11.4_
  
  - [x] 8.2 建立 colorExtractor.js
    - 使用 Canvas API 提取專輯封面主要顏色
    - 實作顏色分析演算法
    - 實作適應性配色應用
    - _需求：8.1, 8.2_
  
  - [ ]* 8.3 撰寫主題系統的屬性測試
    - **屬性 29：主題切換往返**
    - **屬性 30：磨砂玻璃樣式應用**
    - **驗證需求：10.3, 10.4, 11.1, 11.2, 11.4**
  
  - [ ]* 8.4 撰寫適應性配色的屬性測試
    - **屬性 24：適應性配色更新**
    - **屬性 25：停用適應性配色使用預設**
    - **驗證需求：8.1, 8.2, 8.3, 8.4**

- [ ] 9. 實作國際化（i18n）
  - [x] 9.1 設定 vue-i18n
    - 建立 i18n/index.js 配置
    - 建立 zh-TW.json 翻譯檔案
    - 建立 en.json 翻譯檔案
    - 實作語言切換邏輯
    - 實作瀏覽器語言偵測
    - _需求：12.1, 12.2, 12.5_
  
  - [ ]* 9.2 撰寫 i18n 的屬性測試
    - **屬性 31：語言切換更新文字**
    - **屬性 32：語言持久化往返**
    - **驗證需求：12.1, 12.2, 12.3, 12.4**

- [x] 10. 檢查點 - 確保核心服務測試通過
  - 確保所有測試通過，如有問題請詢問使用者。

- [ ] 11. 實作核心 UI 元件
  - [x] 11.1 建立 App.vue 和主要佈局
    - 實作響應式佈局結構
    - 整合 AppHeader、AppSidebar、AppPlayer
    - 應用磨砂玻璃樣式
    - _需求：11.1, 11.2, 13.4_
  
  - [x] 11.2 建立 AppHeader.vue
    - 實作標題和 logo
    - 整合 SearchBar 元件
    - 整合 ThemeToggle 和 LanguageToggle
    - _需求：5.1_
  
  - [x] 11.3 建立 AppSidebar.vue
    - 顯示播放清單列表
    - 顯示分類檢視（藝術家、專輯）
    - 實作檢視切換
    - _需求：3.1, 9.3, 9.4_
  
  - [x] 11.4 建立 AppPlayer.vue（底部播放器控制列）
    - 顯示當前播放音樂資訊和專輯封面
    - 實作播放/暫停按鈕
    - 實作上一首/下一首按鈕
    - 實作進度條
    - 實作音量控制
    - 實作播放模式切換按鈕
    - 應用磨砂玻璃樣式
    - _需求：2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 7.2, 11.4_

- [ ] 12. 實作音樂清單元件
  - [x] 12.1 建立 MusicList.vue
    - 顯示音樂清單（平面或分類檢視）
    - 整合 MusicItem 元件
    - 實作虛擬滾動（如果清單很長）
    - _需求：9.3, 9.4_
  
  - [x] 12.2 建立 MusicItem.vue
    - 顯示音樂資訊（標題、藝術家、時長）
    - 顯示專輯封面縮圖
    - 實作收藏按鈕
    - 實作播放按鈕
    - 實作檔案資訊按鈕
    - 實作右鍵選單（加入播放清單）
    - _需求：4.1, 4.2, 6.1, 7.2_
  
  - [x] 12.3 建立 AlbumCover.vue
    - 顯示專輯封面或預設圖片
    - 處理載入失敗
    - _需求：7.1, 7.2, 7.3, 7.4_
  
  - [x] 12.4 建立 MusicInfo.vue（對話框）
    - 顯示完整的音樂檔案資訊
    - 顯示專輯封面
    - 實作關閉功能
    - _需求：6.1, 6.2, 6.3, 6.4_

- [ ] 13. 實作播放清單管理元件
  - [x] 13.1 建立 PlaylistList.vue
    - 顯示所有播放清單
    - 整合 PlaylistItem 元件
    - 實作建立新播放清單按鈕
    - _需求：3.1_
  
  - [x] 13.2 建立 PlaylistItem.vue
    - 顯示播放清單名稱和音樂數量
    - 實作點擊顯示播放清單內容
    - 實作刪除按鈕
    - 實作右鍵選單（編輯、匯出）
    - _需求：3.4, 3.6_
  
  - [x] 13.3 建立 PlaylistDialog.vue
    - 實作建立播放清單表單
    - 實作編輯播放清單表單
    - 實作驗證
    - _需求：3.1_
  
  - [x] 13.4 建立 PlaylistImportExport.vue
    - 實作匯出為 JSON 功能
    - 實作從 JSON 導入功能
    - 實作錯誤處理
    - _需求：3.6, 3.7, 3.8_
  
  - [ ]* 13.5 撰寫播放清單管理的屬性測試
    - **屬性 11：播放清單建立**
    - **屬性 12：播放清單加入音樂**
    - **屬性 13：播放清單移除音樂保留原檔**
    - **屬性 14：刪除播放清單保留音樂**
    - **屬性 15：播放清單排序更新**
    - **屬性 16：播放清單匯出/導入往返**
    - **屬性 17：無效 JSON 拒絕**
    - **驗證需求：3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8**

- [ ] 14. 實作搜尋功能
  - [x] 14.1 建立 SearchBar.vue
    - 實作搜尋輸入框
    - 實作即時搜尋
    - 實作清除按鈕
    - _需求：5.1, 5.5_
  
  - [x] 14.2 建立 useFuzzySearch.js composable
    - 實作模糊搜尋演算法（Levenshtein 距離或 Fuse.js）
    - 實作多欄位搜尋（標題、藝術家、專輯）
    - _需求：5.2, 5.3_
  
  - [ ]* 14.3 撰寫搜尋功能的屬性測試
    - **屬性 20：搜尋結果匹配**
    - **屬性 21：清除搜尋顯示全部**
    - **驗證需求：5.1, 5.2, 5.3, 5.5**
  
  - [ ]* 14.4 撰寫搜尋功能的單元測試
    - 測試空搜尋結果顯示訊息
    - 測試點擊搜尋結果播放音樂
    - _需求：5.4, 5.6_

- [ ] 15. 實作檔案上傳和收藏功能
  - [x] 15.1 建立 FileUploader.vue
    - 實作檔案選擇按鈕
    - 實作拖放上傳
    - 實作上傳進度顯示
    - 整合 fileUtils 和 metadataService
    - _需求：1.1, 1.2, 1.4_
  
  - [x] 15.2 實作收藏清單檢視
    - 在 MusicList 中加入收藏過濾
    - 在 AppSidebar 中加入「我的最愛」選項
    - _需求：4.3_
  
  - [ ]* 15.3 撰寫收藏功能的屬性測試
    - **屬性 18：收藏切換往返**
    - **屬性 19：收藏清單過濾**
    - **驗證需求：4.1, 4.2, 4.3**

- [x] 16. 檢查點 - 確保 UI 元件測試通過
  - 確保所有測試通過，如有問題請詢問使用者。

- [ ] 17. 實作鍵盤快捷鍵
  - [x] 17.1 建立 useKeyboardShortcuts.js composable
    - 實作鍵盤事件監聽
    - 實作快捷鍵映射（空白鍵、方向鍵、L、S、R）
    - 實作輸入框焦點檢測和快捷鍵停用
    - 整合 player store 和其他功能
    - _需求：14.1, 14.2, 14.3, 14.4, 14.5, 14.6, 14.7, 14.8, 14.9_
  
  - [ ]* 17.2 撰寫鍵盤快捷鍵的屬性測試
    - **屬性 33：鍵盤快捷鍵映射正確性**
    - **屬性 34：輸入框中停用快捷鍵**
    - **驗證需求：14.1-14.9**

- [ ] 18. 實作設定面板
  - [x] 18.1 建立 SettingsPanel.vue
    - 整合 ThemeToggle
    - 整合 LanguageToggle
    - 加入適應性配色開關
    - 加入分類檢視開關
    - _需求：8.3, 8.4, 9.3, 9.4, 10.1, 12.1_
  
  - [x] 18.2 建立 ThemeToggle.vue
    - 實作主題切換按鈕
    - 顯示當前主題
    - _需求：10.1_
  
  - [x] 18.3 建立 LanguageToggle.vue
    - 實作語言切換按鈕
    - 顯示當前語言
    - _需求：12.1_

- [ ] 19. 實作分類檢視
  - [x] 19.1 在 musicLibrary store 中實作分類邏輯
    - 實作按藝術家分組
    - 實作按專輯分組
    - 實作分類檢視切換
    - _需求：9.1, 9.2, 9.3, 9.4_
  
  - [x] 19.2 更新 MusicList.vue 支援分類檢視
    - 實作藝術家/專輯分組顯示
    - 實作點擊分類顯示該分類的音樂
    - _需求：9.5_
  
  - [ ]* 19.3 撰寫分類功能的屬性測試
    - **屬性 26：藝術家分組正確性**
    - **屬性 27：專輯分組正確性**
    - **屬性 28：分類檢視切換**
    - **驗證需求：9.1, 9.2, 9.3, 9.4**

- [ ] 20. 整合和最終調整
  - [x] 20.1 整合所有元件到 App.vue
    - 連接所有 stores
    - 實作應用程式初始化邏輯
    - 載入持久化資料
    - 應用使用者偏好設定
    - _需求：15.5_
  
  - [x] 20.2 實作錯誤處理和使用者回饋
    - 加入 Toast 通知（使用 PrimeVue Toast）
    - 實作錯誤邊界
    - 加入載入狀態指示器
    - _需求：1.4, 3.8, 15.6_
  
  - [x] 20.3 優化效能
    - 實作音樂清單虛擬滾動
    - 優化專輯封面載入（懶載入）
    - 優化 localStorage 讀寫
    - _需求：13.4_
  
  - [ ]* 20.4 撰寫完整資料持久化的屬性測試
    - **屬性 35：完整資料持久化往返**
    - **屬性 36：損壞資料處理**
    - **驗證需求：15.1, 15.2, 15.3, 15.4, 15.5, 15.6**

- [x] 21. 最終檢查點 - 確保所有測試通過
  - 執行所有單元測試和屬性測試
  - 檢查測試覆蓋率（目標 80%+）
  - 確保所有功能正常運作
  - 如有問題請詢問使用者。

- [ ] 22. 文件和部署準備
  - [x] 22.1 撰寫 README.md
    - 專案簡介
    - 功能列表
    - 安裝和執行指南
    - 技術棧說明
  
  - [x] 22.2 建立使用者指南
    - 如何導入音樂
    - 如何建立播放清單
    - 鍵盤快捷鍵列表
    - 設定說明
  
  - [x] 22.3 準備部署配置
    - 設定 Vite 建置配置
    - 建立生產環境建置
    - 測試生產建置

## 注意事項

- 標記 `*` 的任務為可選任務，可以跳過以加快 MVP 開發
- 每個任務都引用了具體的需求以確保可追溯性
- 檢查點確保增量驗證
- 屬性測試驗證通用正確性屬性
- 單元測試驗證特定範例和邊界情況
- 所有測試都應該使用 Vitest 和 fast-check
- 屬性測試應該至少執行 100 次迭代
